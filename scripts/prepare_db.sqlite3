.mode tabs
.separator "\t"
.headers off

-------------------------------------------------------------------------------
-- dbsnp reference data with rs ids

create temp table dbsnp (
    chrom text, pos bigint, id text, ref text, alt text, qual text,
    filter text, info text
);

.import '| grep -v "^#" resources/hg38.dbsnp138.vcf' dbsnp

-------------------------------------------------------------------------------
-- import data from vcf files

create temp table _processed_macs (
    chrom text, pos bigint, ref text, alt text, 
    "all" text, "female" text, "male" text
);

.import '| grep -hv "^#" 02-processed/*.tsv' _processed_macs

-------------------------------------------------------------------------------

create table danmac5 (
    chrom text, 
    pos bigint, 
    id text, 
    ref text, 
    alt text, 
    "all" text,
    female text,
    male text
);

-------------------------------------------------------------------------------
-- add rs ids to 'all'

create temp table _processed_macs_rs as
  select 
     x.chrom, x.pos, y.id, x.ref, x.alt, x."all", x.female, x.male, 1 as flipped
   from _processed_macs x
   inner join dbsnp y
     on x.chrom=y.chrom
    and x.pos=y.pos
    and x.ref=y.alt
    and x.alt=y.ref
  union
  select 
     x.chrom, x.pos, y.id, x.ref, x.alt, x."all", x.female, x.male, 0 as flipped
   from _processed_macs x
   inner join dbsnp y
     on x.chrom=y.chrom
    and x.pos=y.pos
    and x.ref=y.ref
    and x.alt=y.alt
;

insert into danmac5
    select 
        x.chrom, x.pos, y.id, x.ref, x.alt, x."all", x.female, x.male
      from _processed_macs x left join _processed_macs_rs y
        on x.chrom=y.chrom
       and x.pos=y.pos
       and x.ref=y.ref
       and x.alt=y.alt
     where y.id is null
     union
    select 
      chrom, pos, id, ref, alt, "all", female, male
      from _processed_macs_rs
;

-------------------------------------------------------------------------------
-- add indexing 

create index idx_chrom_pos on danmac5 (chrom, pos);
create index idx_id on danmac5 (id);
